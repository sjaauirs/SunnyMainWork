                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
DO $$
DECLARE
    v_tenant_code TEXT := '<KP-TENANT-CODE>';  -- Replace with actual tenant code    
  v_mapping JSONB := '[
        {
            "taskExternalCode": "play_week_heal_triv_2026",
            "taskHeader": "Jugar la trivia saludable",
            "taskDescription": [{"type":"paragraph","data":{"text":"Responda preguntas sobre alimentación, actividad física, bienestar y más para recibir recompensas y tener la oportunidad de obtener otros premios. Es una forma divertida de mantenerse saludable y aprender cosas interesantes."}}],
            "taskCtaButtonText": "Jugar ahora"
        },
        {
           "taskExternalCode": "play_dail_heal_triv_2026",
            "taskHeader": "Jugar la trivia saludable",
            "taskDescription": [{"type":"paragraph","data":{"text":"Responda preguntas sobre alimentación, actividad física, bienestar y más para recibir recompensas y tener la oportunidad de obtener otros premios. Es una forma divertida de mantenerse saludable y aprender cosas interesantes."}}],
            "taskCtaButtonText": "Jugar ahora"
        },
        {
            "taskExternalCode": "star_your_well_coac_2026",
            "taskHeader": "Empezar a recibir orientación sobre bienestar",
            "taskDescription": [{"type":"paragraph","data":{"text":"Reciba orientación y apoyo personalizados de un instructor de bienestar que lo ayudará a establecer objetivos, alcanzarlos y ver los resultados. Se puede hacer directamente desde casa, sin necesidad de una derivación. Conéctese con su instructor por teléfono para conversar sobre cómo alimentarse de manera más saludable, aumentar su actividad física, reducir el estrés y más. Programe su primera cita hoy. Sus recompensas se agregarán automáticamente a la tarjeta de recompensas dentro de 10 días después de su sesión."}}],
            "taskCtaButtonText": "Programar ahora"
        },
        {
            "taskExternalCode": "get_your_flu_vacc_2026",
            "taskHeader": "Recibir su vacuna contra la gripe",
            "taskDescription": [{"type":"paragraph","data":{"text":"Protéjase y proteja a sus seres queridos durante esta temporada de gripe. Evite enfermarse, ir al hospital y recibir facturas médicas inesperadas. Visite a su médico o farmacia local para recibir su vacuna contra la gripe sin costo hoy mismo. Sus recompensas se agregarán automáticamente a la tarjeta de recompensas dentro de 10 días después de su vacuna."}}],
            "taskCtaButtonText": "Programar ahora"
        },
        {
           "taskExternalCode": "play_heal_triv_2026",
            "taskHeader": "Jugar la trivia saludable",
            "taskDescription": [{"type":"paragraph","data":{"text":"Responda preguntas sobre alimentación, actividad física, bienestar y más para recibir recompensas y tener la oportunidad de obtener otros premios. Es una forma divertida de mantenerse saludable y aprender cosas interesantes."}}],
            "taskCtaButtonText": "Jugar ahora"
        },
        {
            "taskExternalCode": "step_it_up_2026",
            "taskHeader": "Avanzar un poco más",
            "taskDescription": [{"type":"paragraph","data":{"text":"Dé un paso más hacia mejor salud, menos estrés y más recompensas. Registre sus pasos con su dispositivo preferido o de forma manual para recibir recompensas cuando alcance los 200,000 pasos cada mes. No olvide sincronizar su dispositivo para que el seguimiento sea más fácil."}},{"type":"paragraph","data":{"text":"\n* Tenga en cuenta que no puede obtener recompensas por las actividades “Avanzar un poco más” y “Ponerse en movimiento” en el mismo mes."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "get_movi_2026",
            "taskHeader": "Ponerse en movimiento",
            "taskDescription": [{"type":"paragraph","data":{"text":"Acelere el ritmo de su corazón y disfrute de más energía. Póngase en movimiento con una caminata, un paseo en bicicleta, una clase de natación o incluso una fiesta de baile en la cocina."}},{"type":"paragraph","data":{"text":"\nRegistre 30 minutos de actividad moderada al menos 5 días por semana hasta alcanzar un total de 600 minutos al mes y reciba las recompensas. No olvide sincronizar su dispositivo para que el seguimiento sea más fácil."}},{"type":"paragraph","data":{"text":"\n* Tenga en cuenta que no puede obtener recompensas por las actividades “Avanzar un poco más” y “Ponerse en movimiento” en el mismo mes."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "stre_your_body_2026",
            "taskHeader": "Fortalecer su cuerpo",
            "taskDescription": [{"type":"paragraph","data":{"text":"Fortalezca sus músculos cada semana. Pruebe con yoga, pilates, entrenamiento con pesas o cualquier actividad que lo ponga en movimiento. Siéntase más fuerte, reduzca el dolor y mejore su equilibrio. Use su aplicación preferida para registrar al menos 2 sesiones por semana y reciba recompensas al completar 8 o más sesiones en un mes. No olvide sincronizar su dispositivo para que el seguimiento sea más fácil."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "get_your_z_s_2026",
            "taskHeader": "Descansar",
            "taskDescription": [{"type":"paragraph","data":{"text":"Los expertos recomiendan dormir de 7 a 9 horas por noche para tener una mente y un cuerpo sanos. Use su dispositivo preferido o lleve un registro manual de su sueño. Registre al menos 7 horas en 4 o más noches por semana. Recibirá recompensas después de alcanzar las 20 noches en un mes. No olvide sincronizar su dispositivo para que el seguimiento sea más fácil."}}],
            "taskCtaButtonText": "Recibir consejos"
        },
        {
            "taskExternalCode": "medi_to_boos_your_well_2026",
            "taskHeader": "Meditar para favorecer su bienestar",
            "taskDescription": [{"type":"paragraph","data":{"text":"Encuentre calma y tranquilidad a través de la meditación y la atención plena. Registre al menos 35 minutos cada semana y reciba recompensas cuando registre 150 minutos en un mes. ¡Se trata de tan solo 5 minutos por día!"}},{"type":"paragraph","data":{"text":"\nUse recursos como una aplicación de meditación, su reloj inteligente u otras herramientas para hacer un seguimiento de los minutos que dedica a la meditación o la atención plena. No olvide sincronizar su dispositivo para que el seguimiento sea más fácil."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "live_a_life_of_grat_2026",
            "taskHeader": "Vivir con gratitud",
            "taskDescription": [{"type":"paragraph","data":{"text":"La gratitud es valorar todo lo bueno que hay en su vida. Escriba 3 cosas por las que se siente agradecido cada día. Puede ser el café que toma por las mañanas, un buen momento de risa o pelar una naranja formando un espiral perfecto."}},{"type":"paragraph","data":{"text":"\nDe enero a marzo, agregue 24 entradas al diario cada mes para recibir su recompensa mensual."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "volu_your_time_2026",
            "taskHeader": "Ofrecerse como voluntario",
            "taskDescription": [{"type":"paragraph","data":{"text":"Ser voluntario mejora su salud y bienestar. De abril a junio, participe como voluntario al menos 2 horas al mes en una causa que sea importante para usted. Suba una foto de su trabajo de voluntariado para recibir su recompensa mensual."}}],
            "taskCtaButtonText": "Explore hoy"
        },
        {
            "taskExternalCode": "powe_down_befo_bed_2026",
            "taskHeader": "Desconectarse antes de dormir",
            "taskDescription": [{"type":"paragraph","data":{"text":"Un buen descanso empieza lejos de las pantallas. Los teléfonos, las tabletas y los televisores emiten una luz azul que impide que el cuerpo produzca la hormona del sueño."}},{"type":"paragraph","data":{"text":"\nApague las pantallas al menos 90 minutos antes de acostarse 5 o más noches por semana. De julio a septiembre, registre 20 noches cada mes para recibir su recompensa mensual."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "conn_with_thos_who_make_you_smil_2026",
            "taskHeader": "Conectarse con personas que lo hacen sonreír",
            "taskDescription": [{"type":"paragraph","data":{"text":"La buena compañía favorece su salud. Llame a un amigo, reúnase para ir a caminar, haga planes para una noche de juegos o haga cualquier otra cosa que le haga sonreír."}},{"type":"paragraph","data":{"text":"\nDe octubre a diciembre, reúnase con un amigo al menos una vez por semana para recibir su recompensa mensual."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "reth_your_drin_2026",
            "taskHeader": "Cambiar las bebidas que consume",
            "taskDescription": [{"type":"paragraph","data":{"text":"Reduzca el consumo de bebidas azucaradas, como refrescos, jugos y bebidas energéticas. Elija agua u otras bebidas sin azúcar al menos 6 días por semana. Reciba recompensas cuando alcance los 24 días de tomar solo bebidas sin azúcar cada mes."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "take_a_brea_from_alco_in_janu_2026",
            "taskHeader": "Tómese un descanso del alcohol",
            "taskDescription": [{"type":"paragraph","data":{"text":"Comience el año nuevo reiniciando su cuerpo. Dejar de consumir alcohol puede mejorar su salud, su sueño y su energía. Registre sus días sin alcohol y reciba su recompensa mensual. Para ganar las recompensas de enero, registre hasta el 10 de febrero."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "take_a_brea_from_alco_in_febr_2026",
            "taskHeader": "Tómese un descanso del alcohol",
            "taskDescription": [{"type":"paragraph","data":{"text":"Comience el año nuevo reiniciando su cuerpo. Dejar de consumir alcohol puede mejorar su salud, su sueño y su energía. Registre sus días sin alcohol y reciba su recompensa mensual. Para ganar las recompensas de febrero, registre hasta el 10 de marzo."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "take_a_brea_from_alco_in_marc_2026",
            "taskHeader": "Tómese un descanso del alcohol",
            "taskDescription": [{"type":"paragraph","data":{"text":"Comience el año nuevo reiniciando su cuerpo. Dejar de consumir alcohol puede mejorar su salud, su sueño y su energía. Registre sus días sin alcohol y reciba su recompensa mensual. Para ganar las recompensas de marzo, registre hasta el 10 de abril."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "take_a_stro_afte_a_meal_2026",
            "taskHeader": "Dar un paseo después de comer",
            "taskDescription": [{"type":"paragraph","data":{"text":"Lavar los platos puede esperar. Incluso una caminata corta después de comer puede ayudar a que su cuerpo y cerebro se sientan a gusto. Caminar estabiliza el azúcar en sangre, ayuda con la digestión, estimula el metabolismo y puede mejorar el estado de ánimo."}},{"type":"paragraph","data":{"text":"\nDe abril a junio, camine 10 minutos después de comer al menos 5 días por semana. Reciba su recompensa mensual cuando sume 20 días en el mes."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "eat_the_rain_2026",
            "taskHeader": "Alimentarse en forma de arcoíris",
            "taskDescription": [{"type":"paragraph","data":{"text":"Alimente su cuerpo con todos los colores del arcoíris. Las frutas y verduras de color verde, rojo, naranja, amarillo, azul y morado contienen las vitaminas y los nutrientes que necesita."}},{"type":"paragraph","data":{"text":"\nDe julio a septiembre, lleve un registro de las comidas con una aplicación o escríbalas. Come 3 o más colores del arcoíris 2 o más días por semana y recibirá una recompensa mensual cuando llegue a 8 días."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "eat_more_seed_and_nuts_2026",
            "taskHeader": "Comer más semillas y frutos secos",
            "taskDescription": [{"type":"paragraph","data":{"text":"Los frutos secos y las semillas son pequeños pero poderosos. Aportan proteínas, fibra y grasas saludables para el corazón, cerebro y cuerpo. Agréguelos a ensaladas, yogur o avena, o cómalos como refrigerio rápido."}},{"type":"paragraph","data":{"text":"\nDe octubre a diciembre, coma al menos una porción de frutos secos o semillas 5 veces por semana para recibir su recompensa mensual cuando llegue a los 20 días."}}],
            "taskCtaButtonText": "Más información"
        },
        {
            "taskExternalCode": "comp_the_tota_heal_asse_2026",
            "taskHeader": "Completar la Evaluación Total de Salud",
            "taskDescription": [{"type":"paragraph","data":{"text":"El conocimiento es poder. Complete la Evaluación de Total de Salud para conocer su salud y recibir consejos para alcanzar sus objetivos de bienestar. Sus recompensas se agregarán automáticamente a la tarjeta de recompensas dentro de 10 días después de completar la evaluación."}}],
            "taskCtaButtonText": "Empezar ahora"
        },
        {
            "taskExternalCode": "shar_your_feed_2026",
            "taskHeader": "Compartir sus comentarios",
            "taskDescription": [{"type":"paragraph","data":{"text":"¡Queremos conocer su opinión! Dedique unos minutos a completar una breve encuesta y díganos cómo podemos mejorar nuestro programa de recompensas."}}],
            "taskCtaButtonText": "Completar ahora"
        }
    ]';


   item JSONB;
    v_task_external_code TEXT;
    v_task_header TEXT;
    v_task_description TEXT;
    v_cta_description TEXT;

    v_task_id BIGINT;
    v_tos_id BIGINT;  -- adjust if you need a specific terms_of_service_id
    v_lang TEXT := 'es';
    v_create_user TEXT := 'SYSTEM';  
    rows_updated INT;
BEGIN
    -- Loop through each item in the JSON array
    FOR item IN SELECT * FROM jsonb_array_elements(v_mapping)
    LOOP
        -- Extract fields from the JSON object
        v_task_external_code := item ->> 'taskExternalCode';
        v_task_description   := (item -> 'taskDescription')::text;  -- cast JSON array to text
        v_task_header        := item ->> 'taskHeader';
        v_cta_description    := item ->> 'taskCtaButtonText';

        RAISE NOTICE 'Processing taskExternalCode: % for tenant: %', v_task_external_code, v_tenant_code;
       
       SELECT terms_of_service_id
    INTO v_tos_id
    FROM task.terms_of_service
    WHERE language_code = v_lang
      AND delete_nbr = 0 order by 1 desc
    LIMIT 1;
        -- Get matching task_ids for the given tenant and external code
        FOR v_task_id IN
            SELECT task_id
            FROM task.task_reward
            WHERE tenant_code = v_tenant_code
              AND task_external_code = v_task_external_code
              AND delete_nbr = 0
        LOOP
            RAISE NOTICE 'Found task_id: % for taskExternalCode: %', v_task_id, v_task_external_code;

            -- Try update first
            UPDATE task.task_detail
            SET task_header        = v_task_header,
                task_description   = v_task_description,
                terms_of_service_id= v_tos_id,
                update_user        = v_create_user,
                update_ts          = NOW(),
                task_cta_button_text = v_cta_description,
                delete_nbr         = 0
            WHERE task_id = v_task_id
              AND language_code = v_lang
              AND tenant_code = v_tenant_code and delete_nbr=0;

            IF NOT FOUND THEN
                -- Insert if no row was updated
                INSERT INTO task.task_detail (
                    task_id,
                    language_code,
                    task_header,
                    task_description,
                    terms_of_service_id,
                    create_user,
                    create_ts,
                    delete_nbr,
                    task_cta_button_text,
                    tenant_code
                )
                VALUES (
                    v_task_id,
                    v_lang,
                    v_task_header,
                    v_task_description,
                    v_tos_id,
                    v_create_user,
                    NOW(),
                    0,
                    v_cta_description,
                    v_tenant_code
                );

                RAISE NOTICE 'Inserted task_detail for task_id: %', v_task_id;
            ELSE
                RAISE NOTICE 'Updated task_detail for task_id: %', v_task_id;
            END IF;
        END LOOP;
    END LOOP;
END $$;